{% extends 'base.html' %}
{% load static %}

{% block title %}{{ object.surname }} - Student{% endblock title %}

{% block content-header %}
<div class="card-header bg-primary text-white">
  <div class="d-flex justify-content-between align-items-center flex-wrap">
    <div class="mb-2 mb-md-0">
      <h5 class="card-title mb-0">
        <i class="fas fa-user-graduate mr-2"></i>
        Student Profile
      </h5>
      <small class="text-white-50">{{ object.current_class }}</small>
    </div>
    <div class="btn-group btn-group-sm">
      <a href="#" class="btn btn-light">
        <i class="fas fa-print"></i>
      </a>
      <a href="{% url 'student-update' object.id %}" class="btn btn-light">
        <i class="fas fa-edit"></i>
      </a>
      <a href="{% url 'student-delete' object.id %}" class="btn btn-light">
        <i class="fas fa-trash"></i>
      </a>
    </div>
  </div>
</div>
{% endblock content-header %}

{% block content %}
<div class="row">
  <!-- Student Profile - Stack on mobile -->
  <div class="col-12 col-md-4 mb-3">
    <div class="card">
      <div class="card-body text-center p-3">
        {% if object.passport %}
          <img src="{{ object.passport.url }}" class="rounded-circle profile-img-mobile mb-2" alt="Student Photo">
        {% else %}
          <img src="{% static 'dist/img/avatar.png' %}" class="rounded-circle profile-img-mobile mb-2" alt="Default Avatar">
        {% endif %}
        
        <h6 class="mb-1">{{ object.surname }}</h6>
        <h6 class="mb-1 text-primary">{{ object.firstname }}</h6>
        {% if object.other_name %}
          <small class="text-muted">{{ object.other_name }}</small>
        {% endif %}
        
        <div class="mt-2">
          <span class="badge badge-secondary">
            {{ object.registration_number }}
          </span>
        </div>

        <div class="student-meta mt-3">
          <div class="d-flex justify-content-between text-sm mb-1">
            <span>Class:</span>
            <strong>{{ object.current_class }}</strong>
          </div>
          <div class="d-flex justify-content-between text-sm mb-1">
            <span>Gender:</span>
            <span>{{ object.get_gender_display }}</span>
          </div>
          <div class="d-flex justify-content-between text-sm">
            <span>Status:</span>
            <span class="badge {% if object.current_status == 'active' %}badge-success{% else %}badge-danger{% endif %}">
              {{ object.get_current_status_display }}
            </span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Student Details - Full width on mobile -->
  <div class="col-12 col-md-8">
    <div class="card">
      <div class="card-header bg-light py-2">
        <h6 class="card-title mb-0">
          <i class="fas fa-info-circle mr-2 text-primary"></i>
          Information
        </h6>
      </div>
      <div class="card-body p-0">
        <div class="list-group list-group-flush">
          <div class="list-group-item d-flex justify-content-between align-items-center py-2">
            <span>Date of Birth</span>
            <span class="text-muted">{{ object.date_of_birth|default:"-" }}</span>
          </div>
          <div class="list-group-item d-flex justify-content-between align-items-center py-2">
            <span>Parent Mobile</span>
            <span class="text-muted">{{ object.parent_mobile_number|default:"-" }}</span>
          </div>
          <div class="list-group-item py-2">
            <div class="d-flex justify-content-between mb-1">
              <span>Guardian</span>
            </div>
            <small class="text-muted">
              {{ object.guardian_name }} ({{ object.relationship }})<br>
              {{ object.guardian_phone }}
            </small>
          </div>
          <div class="list-group-item d-flex justify-content-between align-items-center py-2">
            <span>Emergency Contact</span>
            <span class="text-muted">{{ object.emergency_contact|default:"-" }}</span>
          </div>
          <div class="list-group-item py-2">
            <div class="d-flex justify-content-between mb-1">
              <span>Address</span>
            </div>
            <small class="text-muted">{{ object.address|default:"Not specified"|truncatewords:10 }}</small>
          </div>
          <div class="list-group-item py-2">
            <div class="d-flex justify-content-between mb-1">
              <span>Medical Notes</span>
            </div>
            <small class="text-muted">{{ object.medical_notes|default:"None"|truncatewords:10 }}</small>
          </div>
          <div class="list-group-item py-2">
            <div class="d-flex justify-content-between mb-1">
              <span>Services</span>
            </div>
            <div>
              {% if object.house %}
                <span class="badge badge-primary badge-sm mr-1">{{ object.house }}</span>
              {% endif %}
              {% if object.transport_opt_in %}
                <span class="badge badge-info badge-sm mr-1">Transport</span>
              {% endif %}
              {% if object.lunch_opt_in %}
                <span class="badge badge-success badge-sm">Lunch</span>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Payment History - Full width -->
<div class="row mt-3">
  <div class="col-12">
    <div class="card">
      <div class="card-header bg-info text-white py-2">
        <h6 class="card-title mb-0">
          <i class="fas fa-file-invoice-dollar mr-2"></i>
          Payment History
        </h6>
      </div>
      <div class="card-body p-0">
        {% if payments %}
        <div class="table-responsive">
          <table class="table table-sm table-hover mb-0">
            <thead class="thead-light">
              <tr>
                <th>Period</th>
                <th class="d-none d-sm-table-cell">Payable</th>
                <th>Paid</th>
                <th>Balance</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              {% for payment in payments %}
              <tr class='clickable-row' data-href="{% url 'invoice-detail' payment.id %}">
                <td>
                  <small>
                    <div>{{ payment.session }}</div>
                    <div class="text-muted">{{ payment.term }}</div>
                  </small>
                </td>
                <td class="d-none d-sm-table-cell">
                  <small>₦{{ payment.total_amount_payable }}</small>
                </td>
                <td>
                  <small class="text-success">₦{{ payment.total_amount_paid }}</small>
                </td>
                <td>
                  <small class="{% if payment.balance > 0 %}text-danger{% else %}text-success{% endif %}">
                    ₦{{ payment.balance }}
                  </small>
                </td>
                <td>
                  {% if payment.balance == 0 %}
                    <span class="badge badge-success badge-sm">Paid</span>
                  {% elif payment.balance == payment.total_amount_payable %}
                    <span class="badge badge-danger badge-sm">Due</span>
                  {% else %}
                    <span class="badge badge-warning badge-sm">Partial</span>
                  {% endif %}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% else %}
        <div class="text-center py-4">
          <i class="fas fa-receipt fa-2x text-muted mb-2"></i>
          <p class="text-muted mb-0">No payment records</p>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<style>
.profile-img-mobile {
  width: 80px;
  height: 80px;
  object-fit: cover;
}

.badge-sm {
  font-size: 0.7rem;
  padding: 0.25em 0.4em;
}

.text-sm {
  font-size: 0.875rem;
}

.student-meta {
  background: #f8f9fa;
  padding: 0.75rem;
  border-radius: 0.375rem;
  margin-top: 0.5rem;
}

.list-group-item {
  border-color: #f8f9fa;
}

/* Mobile optimizations */
@media (max-width: 768px) {
  .card-body {
    padding: 0.75rem;
  }
  
  .btn-group-sm .btn {
    padding: 0.25rem 0.5rem;
  }
  
  .table-responsive {
    font-size: 0.8rem;
  }
}

/* Better touch targets */
.clickable-row {
  min-height: 44px; /* Apple's recommended minimum touch target */
}

.list-group-item {
  min-height: 44px;
  display: flex;
  align-items: center;
}
</style>
{% endblock content %}