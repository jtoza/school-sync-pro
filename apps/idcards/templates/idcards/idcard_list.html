{% extends 'base.html' %}
{% load static %}

{% block title %}
ID Card Directory
{% endblock title %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card bg-gradient-info text-white">
                <div class="card-body py-4">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h2 class="card-title mb-1">
                                <i class="fas fa-address-card me-3"></i>ID Card Directory
                            </h2>
                            <p class="card-text opacity-75 mb-0">Manage and view all student identification cards</p>
                        </div>
                        <div class="text-end">
                            <span class="badge bg-light text-info fs-6 p-2">
                                {{ idcards.paginator.count }} Cards
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters and Search -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm border-0">
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <input type="text" class="form-control" placeholder="Search by name or ID..." id="searchInput">
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="statusFilter">
                                <option value="">All Status</option>
                                <option value="active">Active</option>
                                <option value="expired">Expired</option>
                                <option value="inactive">Inactive</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="classFilter">
                                <option value="">All Classes</option>
                                {% for class in classes %}
                                <option value="{{ class.id }}">{{ class.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-2">
                            <button class="btn btn-primary w-100" id="applyFilters">
                                <i class="fas fa-filter me-2"></i>Filter
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ID Cards Grid -->
    <div class="row" id="idCardsGrid">
        {% for idcard in idcards %}
        <div class="col-xl-3 col-lg-4 col-md-6 mb-4 id-card-item" 
             data-status="{% if idcard.is_active %}active{% else %}inactive{% endif %}" 
             data-class="{{ idcard.student.current_class.id }}">
            <div class="card shadow-sm border-0 h-100">
                <!-- Card Status Badge -->
                <div class="card-status {% if not idcard.is_active %}bg-secondary{% elif idcard.expiry_date < today %}bg-warning{% else %}bg-success{% endif %}">
                    {% if not idcard.is_active %}
                        <i class="fas fa-ban"></i> Inactive
                    {% elif idcard.expiry_date < today %}
                        <i class="fas fa-exclamation-triangle"></i> Expired
                    {% else %}
                        <i class="fas fa-check"></i> Active
                    {% endif %}
                </div>
                
                <div class="card-body text-center p-4">
                    <!-- Student Avatar -->
                    <div class="avatar-lg bg-light rounded-circle mx-auto mb-3">
                        {% if idcard.student.passport %}
                            <img src="{{ idcard.student.passport.url }}" alt="Avatar" class="rounded-circle" style="width: 80px; height: 80px; object-fit: cover;">
                        {% else %}
                            <i class="fas fa-user-graduate fa-3x text-muted p-3"></i>
                        {% endif %}
                    </div>
                    
                    <!-- Student Info -->
                    <h5 class="card-title mb-1">{{ idcard.student.get_full_name }}</h5>
                    <p class="text-muted small mb-2">{{ idcard.student.registration_number }}</p>
                    
                    <div class="badge bg-primary mb-3">{{ idcard.student.current_class }}</div>
                    
                    <!-- ID Card Details -->
                    <div class="id-card-details">
                        <div class="detail-item">
                            <small class="text-muted">ID Number</small>
                            <div class="fw-bold text-success">{{ idcard.id_number }}</div>
                        </div>
                        <div class="detail-item">
                            <small class="text-muted">Issued</small>
                            <div>{{ idcard.issue_date|date:"M d, Y" }}</div>
                        </div>
                        <div class="detail-item">
                            <small class="text-muted">Expires</small>
                            <div class="{% if idcard.expiry_date < today %}text-danger{% endif %}">
                                {{ idcard.expiry_date|date:"M d, Y" }}
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Card Actions -->
                <div class="card-footer bg-transparent border-0 pt-0">
                    <div class="btn-group w-100">
                        <a href="{% url 'idcards:generate-idcard' idcard.student.id %}" 
                           class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-eye"></i>
                        </a>
                        <a href="{% url 'idcards:download-idcard' idcard.student.id %}" 
                           class="btn btn-outline-success btn-sm">
                            <i class="fas fa-download"></i>
                        </a>
                        <a href="{% url 'idcards:renew-idcard' idcard.student.id %}" 
                           class="btn btn-outline-warning btn-sm">
                            <i class="fas fa-sync-alt"></i>
                        </a>
                        <a href="{% url 'students:student-detail' idcard.student.id %}" 
                           class="btn btn-outline-info btn-sm">
                            <i class="fas fa-user"></i>
                        </a>
                    </div>
                </div>
            </div>
        </div>
        {% empty %}
        <div class="col-12">
            <div class="card shadow-sm border-0">
                <div class="card-body text-center py-5">
                    <i class="fas fa-address-card fa-4x text-muted mb-3"></i>
                    <h4 class="text-muted">No ID Cards Found</h4>
                    <p class="text-muted">No student ID cards have been generated yet.</p>
                    <a href="{% url 'idcards:bulk-generate' %}" class="btn btn-primary">
                        <i class="fas fa-layer-group me-2"></i>Generate ID Cards
                    </a>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Pagination -->
    {% if idcards.paginator.num_pages > 1 %}
    <div class="row">
        <div class="col-12">
            <nav aria-label="ID Cards pagination">
                <ul class="pagination justify-content-center">
                    {% if idcards.has_previous %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ idcards.previous_page_number }}">Previous</a>
                    </li>
                    {% endif %}
                    
                    {% for num in idcards.paginator.page_range %}
                    <li class="page-item {% if idcards.number == num %}active{% endif %}">
                        <a class="page-link" href="?page={{ num }}">{{ num }}</a>
                    </li>
                    {% endfor %}
                    
                    {% if idcards.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ idcards.next_page_number }}">Next</a>
                    </li>
                    {% endif %}
                </ul>
            </nav>
        </div>
    </div>
    {% endif %}
</div>

<style>
.bg-gradient-info {
    background: linear-gradient(135deg, #17a2b8 0%, #6f42c1 100%) !important;
}

.avatar-lg {
    width: 100px;
    height: 100px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.card-status {
    position: absolute;
    top: 10px;
    right: 10px;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 0.7rem;
    font-weight: 600;
    color: white;
    z-index: 1;
}

.id-card-details {
    border-top: 1px solid #e9ecef;
    padding-top: 15px;
    margin-top: 15px;
}

.detail-item {
    margin-bottom: 8px;
}

.detail-item:last-child {
    margin-bottom: 0;
}

.btn-group .btn {
    border-radius: 0;
}

.btn-group .btn:first-child {
    border-top-left-radius: 0.375rem;
    border-bottom-left-radius: 0.375rem;
}

.btn-group .btn:last-child {
    border-top-right-radius: 0.375rem;
    border-bottom-right-radius: 0.375rem;
}

.card {
    transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
}

.card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.1) !important;
}

.page-item.active .page-link {
    background-color: #17a2b8;
    border-color: #17a2b8;
}

.page-link {
    color: #17a2b8;
}

.page-link:hover {
    color: #138496;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('searchInput');
    const statusFilter = document.getElementById('statusFilter');
    const classFilter = document.getElementById('classFilter');
    const applyFilters = document.getElementById('applyFilters');
    const idCardItems = document.querySelectorAll('.id-card-item');

    function filterCards() {
        const searchTerm = searchInput.value.toLowerCase();
        const statusValue = statusFilter.value;
        const classValue = classFilter.value;

        idCardItems.forEach(item => {
            const studentName = item.querySelector('.card-title').textContent.toLowerCase();
            const status = item.getAttribute('data-status');
            const classId = item.getAttribute('data-class');
            
            const matchesSearch = studentName.includes(searchTerm);
            const matchesStatus = !statusValue || status === statusValue;
            const matchesClass = !classValue || classId === classValue;
            
            if (matchesSearch && matchesStatus && matchesClass) {
                item.style.display = 'block';
            } else {
                item.style.display = 'none';
            }
        });
    }

    searchInput.addEventListener('input', filterCards);
    applyFilters.addEventListener('click', filterCards);
    
    // Also filter on Enter key in search
    searchInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            filterCards();
        }
    });
});
</script>
{% endblock content %}