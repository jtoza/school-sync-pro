{% extends 'base.html' %}
{% load widget_tweaks %}

{% block title %}
Update Results for Selected Students
{% endblock title %}

{% block content %}
<form method="POST">
  {% csrf_token %}
  {{ formset.management_form }}

  <div class="card">
    <div class="card-header bg-primary text-white">
      <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center">
        <div class="mb-2 mb-md-0">
          <h5 class="card-title mb-1">
            <i class="fas fa-edit me-2"></i>
            Update Results
          </h5>
          <small class="opacity-75">{{ selected_students_count }} Student(s) | {{ subjects_count }} Subjects</small>
        </div>
        <div class="d-flex flex-wrap gap-2">
          <span class="badge bg-light text-dark">{{ session }} | {{ term }}</span>
          <button type="submit" class="btn btn-success btn-sm">
            <i class="fas fa-save me-1"></i> Save All
          </button>
        </div>
      </div>
    </div>
    
    <div class="card-body p-0">
      {% for student_data in students_data %}
      <div class="student-section border-bottom">
        <!-- Student Header - Mobile Friendly -->
        <div class="bg-light p-3">
          <div class="d-flex flex-column flex-sm-row justify-content-between align-items-start align-items-sm-center">
            <div class="mb-2 mb-sm-0">
              <h6 class="mb-1 text-dark">
                <i class="fas fa-user me-2"></i>
                {{ student_data.student.get_full_name|default:student_data.student }}
              </h6>
              <div class="d-flex flex-wrap gap-2">
                <small class="text-muted">
                  {{ student_data.student.registration_number }}
                </small>
                <small class="text-muted">|</small>
                <small class="text-muted">
                  {{ student_data.student.current_class }}
                </small>
              </div>
            </div>
            <span class="badge bg-primary">{{ student_data.results_count }} subjects</span>
          </div>
        </div>
        
        <!-- Results Table - Responsive -->
        <div class="table-responsive">
          <table class="table table-sm table-hover mb-0 d-none d-md-table">
            <thead class="table-light">
              <tr>
                <th style="width: 5%;">#</th>
                <th style="width: 20%;">Subject</th>
                <th style="width: 12%;">Test (40)</th>
                <th style="width: 12%;">Exam (60)</th>
                <th style="width: 10%;">Total</th>
                <th style="width: 8%;">Grade</th>
                <th style="width: 18%;">Teacher Comment</th>
                <th style="width: 18%;">Head Comment</th>
                <th style="width: 7%;" class="text-center">Delete</th>
              </tr>
            </thead>
            <tbody>
              {% for form in student_data.forms %}
              {{ form.id }}
              <tr>
                <td class="text-muted">{{ forloop.counter }}</td>
                <td class="fw-medium">{{ form.instance.subject }}</td>
                <td>
                  {{ form.test_score|add_class:"form-control form-control-sm score-input"|attr:"placeholder:0-40" }}
                </td>
                <td>
                  {{ form.exam_score|add_class:"form-control form-control-sm score-input"|attr:"placeholder:0-60" }}
                </td>
                <td class="total-cell text-center fw-bold">
                  <span class="badge {% if form.instance.total_score >= 50 %}bg-success{% else %}bg-warning{% endif %}">
                    {{ form.instance.total_score|default:"0" }}
                  </span>
                </td>
                <td class="grade-cell text-center fw-bold">
                  <span class="badge grade-{{ form.instance.grade }}">{{ form.instance.grade|default:"-" }}</span>
                </td>
                <td>
                  {{ form.teacher_comment|add_class:"form-control form-control-sm"|attr:"placeholder:Teacher's comment..." }}
                </td>
                <td>
                  {{ form.headteacher_comment|add_class:"form-control form-control-sm"|attr:"placeholder:Head's comment..." }}
                </td>
                <td class="text-center">
                  <div class="form-check d-inline-block">
                    {{ form.DELETE|add_class:"form-check-input delete-checkbox" }}
                  </div>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>

          <!-- Mobile Cards View -->
          <div class="d-md-none">
            {% for form in student_data.forms %}
            {{ form.id }}
            <div class="card m-3 border">
              <div class="card-header bg-light py-2">
                <div class="d-flex justify-content-between align-items-center">
                  <h6 class="mb-0 text-dark">{{ form.instance.subject }}</h6>
                  <span class="badge bg-secondary">#{{ forloop.counter }}</span>
                </div>
              </div>
              <div class="card-body">
                <!-- Scores Row -->
                <div class="row g-2 mb-3">
                  <div class="col-6">
                    <label class="form-label small fw-bold mb-1">Test Score (40)</label>
                    {{ form.test_score|add_class:"form-control score-input"|attr:"placeholder:0-40" }}
                  </div>
                  <div class="col-6">
                    <label class="form-label small fw-bold mb-1">Exam Score (60)</label>
                    {{ form.exam_score|add_class:"form-control score-input"|attr:"placeholder:0-60" }}
                  </div>
                </div>

                <!-- Total and Grade Row -->
                <div class="row g-2 mb-3">
                  <div class="col-6">
                    <label class="form-label small fw-bold mb-1">Total</label>
                    <div class="total-cell text-center fw-bold">
                      <span class="badge {% if form.instance.total_score >= 50 %}bg-success{% else %}bg-warning{% endif %} p-2 w-100">
                        {{ form.instance.total_score|default:"0" }}
                      </span>
                    </div>
                  </div>
                  <div class="col-6">
                    <label class="form-label small fw-bold mb-1">Grade</label>
                    <div class="grade-cell text-center fw-bold">
                      <span class="badge grade-{{ form.instance.grade }} p-2 w-100">
                        {{ form.instance.grade|default:"-" }}
                      </span>
                    </div>
                  </div>
                </div>

                <!-- Comments -->
                <div class="row g-2 mb-3">
                  <div class="col-12">
                    <label class="form-label small fw-bold mb-1">Teacher Comment</label>
                    {{ form.teacher_comment|add_class:"form-control"|attr:"placeholder:Teacher's comment..."|attr:"rows:2" }}
                  </div>
                  <div class="col-12">
                    <label class="form-label small fw-bold mb-1">Headteacher Comment</label>
                    {{ form.headteacher_comment|add_class:"form-control"|attr:"placeholder:Head's comment..."|attr:"rows:2" }}
                  </div>
                </div>

                <!-- Delete Option -->
                <div class="row">
                  <div class="col-12">
                    <div class="form-check">
                      {{ form.DELETE|add_class:"form-check-input delete-checkbox" }}
                      <label class="form-check-label small text-danger fw-bold" for="{{ form.DELETE.id_for_label }}">
                        Delete this result
                      </label>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            {% endfor %}
          </div>
        </div>
      </div>
      {% empty %}
      <div class="text-center py-5">
        <i class="fas fa-users fa-3x text-muted mb-3"></i>
        <h5 class="text-muted">No students selected</h5>
        <p class="text-muted">Please go back and select students to enter marks for.</p>
        <a href="{% url 'create-result' %}" class="btn btn-primary">
          <i class="fas fa-arrow-left me-1"></i> Back to Student Selection
        </a>
      </div>
      {% endfor %}
    </div>
    
    {% if students_data %}
    <div class="card-footer bg-light">
      <div class="d-flex flex-column flex-md-row justify-content-between align-items-center">
        <small class="text-muted text-center text-md-start mb-2 mb-md-0">
          <i class="fas fa-info-circle me-1"></i>
          Enter scores (0-40 for test, 0-60 for exam). Totals and grades update automatically.
        </small>
        <div class="d-flex flex-column flex-sm-row gap-2 w-100 w-md-auto">
          <a href="{% url 'create-result' %}" class="btn btn-outline-secondary order-2 order-sm-1">
            <i class="fas fa-arrow-left me-1"></i> Back
          </a>
          <button type="submit" class="btn btn-success order-1 order-sm-2">
            <i class="fas fa-save me-1"></i> Save All Changes
          </button>
        </div>
      </div>
    </div>
    {% endif %}
  </div>
</form>

<style>
.student-section:last-child {
  border-bottom: none !important;
}

.score-input {
  text-align: center;
  font-weight: 500;
}

.table th {
  border-top: none;
  font-weight: 600;
  font-size: 0.8rem;
  white-space: nowrap;
}

.table td {
  vertical-align: middle;
  font-size: 0.85rem;
}

.grade-A { background-color: #28a745; color: white; }
.grade-B { background-color: #17a2b8; color: white; }
.grade-C { background-color: #ffc107; color: black; }
.grade-D { background-color: #fd7e14; color: white; }
.grade-E { background-color: #6c757d; color: white; }
.grade-F { background-color: #dc3545; color: white; }

.delete-checkbox {
  transform: scale(1.2);
}

/* Mobile-specific styles */
@media (max-width: 767.98px) {
  .card-header .d-flex {
    text-align: center;
  }
  
  .card-body {
    padding: 0;
  }
  
  .student-section .bg-light {
    padding: 1rem !important;
  }
  
  .table-responsive {
    border: none;
  }
  
  /* Mobile card styles */
  .d-md-none .card {
    margin: 0.75rem;
    border-radius: 0.5rem;
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
  }
  
  .d-md-none .card-header {
    padding: 0.75rem 1rem;
  }
  
  .d-md-none .card-body {
    padding: 1rem;
  }
  
  .form-control {
    padding: 0.75rem;
    font-size: 1rem; /* Larger touch targets */
  }
  
  .btn {
    padding: 0.75rem 1.5rem;
    font-size: 1rem;
  }
  
  /* Ensure proper spacing on mobile */
  .row.g-2 > [class*="col-"] {
    margin-bottom: 1rem;
  }
  
  .row.g-2 > [class*="col-"]:last-child {
    margin-bottom: 0;
  }
}

/* Small mobile devices */
@media (max-width: 575.98px) {
  .card-header {
    padding: 1rem;
  }
  
  .card-footer {
    padding: 1rem;
  }
  
  .btn {
    width: 100%;
    margin-bottom: 0.5rem;
  }
  
  .d-flex.flex-column .btn:last-child {
    margin-bottom: 0;
  }
  
  .student-section .d-flex {
    text-align: center;
  }
  
  .badge {
    font-size: 0.75rem;
    margin-top: 0.25rem;
  }
  
  /* Stack header elements on very small screens */
  .card-header .flex-column .mb-2 {
    margin-bottom: 0.5rem !important;
  }
}

/* Tablet styles */
@media (min-width: 768px) and (max-width: 991.98px) {
  .table th, .table td {
    padding: 0.5rem;
    font-size: 0.8rem;
  }
  
  .form-control-sm {
    padding: 0.25rem 0.5rem;
    font-size: 0.8rem;
  }
}

/* Ensure proper touch targets on all devices */
.form-control, .form-select, .btn {
  min-height: 44px;
}

/* Loading state for buttons */
.btn-loading {
  position: relative;
  color: transparent;
}

.btn-loading:after {
  content: '';
  position: absolute;
  left: 50%;
  top: 50%;
  width: 20px;
  height: 20px;
  margin: -10px 0 0 -10px;
  border: 2px solid #ffffff;
  border-radius: 50%;
  border-right-color: transparent;
  animation: spin 0.8s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const calculateGrade = (total) => {
    const score = parseFloat(total) || 0;
    if (score >= 80) return 'A';
    if (score >= 70) return 'B';
    if (score >= 60) return 'C';
    if (score >= 50) return 'D';
    if (score >= 40) return 'E';
    return 'F';
  };

  const getGradeClass = (grade) => {
    return `grade-${grade}`;
  };

  // Live compute total and grade on input
  document.addEventListener('input', function(e) {
    if (!e.target.classList.contains('score-input')) return;
    
    const isMobile = window.innerWidth < 768;
    let container;
    
    if (isMobile) {
      // Mobile: find the parent card
      container = e.target.closest('.card');
    } else {
      // Desktop: find the parent table row
      container = e.target.closest('tr');
    }
    
    if (!container) return;
    
    let testInput, examInput, totalCell, gradeCell;
    
    if (isMobile) {
      // Mobile selectors
      testInput = container.querySelector('input[name$="-test_score"]');
      examInput = container.querySelector('input[name$="-exam_score"]');
      totalCell = container.querySelector('.total-cell');
      gradeCell = container.querySelector('.grade-cell');
    } else {
      // Desktop selectors
      testInput = container.querySelector('input[name$="-test_score"]');
      examInput = container.querySelector('input[name$="-exam_score"]');
      totalCell = container.querySelector('.total-cell');
      gradeCell = container.querySelector('.grade-cell');
    }
    
    // Validate and constrain scores
    let test = parseFloat(testInput.value) || 0;
    let exam = parseFloat(examInput.value) || 0;
    
    test = Math.min(Math.max(test, 0), 40);
    exam = Math.min(Math.max(exam, 0), 60);
    
    testInput.value = test;
    examInput.value = exam;
    
    const total = test + exam;
    const grade = calculateGrade(total);
    
    // Update display
    if (isMobile) {
      totalCell.innerHTML = `<span class="badge ${total >= 50 ? 'bg-success' : 'bg-warning'} p-2 w-100">${total}</span>`;
      gradeCell.innerHTML = `<span class="badge ${getGradeClass(grade)} p-2 w-100">${grade}</span>`;
    } else {
      totalCell.innerHTML = `<span class="badge ${total >= 50 ? 'bg-success' : 'bg-warning'}">${total}</span>`;
      gradeCell.innerHTML = `<span class="badge ${getGradeClass(grade)}">${grade}</span>`;
    }
  });

  // Form submission loading state
  const form = document.querySelector('form');
  const submitBtn = form.querySelector('button[type="submit"]');
  
  form.addEventListener('submit', function() {
    submitBtn.disabled = true;
    submitBtn.classList.add('btn-loading');
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Saving...';
  });

  // Auto-focus first score field
  const firstScoreInput = document.querySelector('.score-input');
  if (firstScoreInput) {
    firstScoreInput.focus();
  }
});
</script>
{% endblock content %}