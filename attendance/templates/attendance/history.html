{% extends 'base.html' %}
{% load static %}

{% block title %}Attendance History{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="row mb-4">
    <div class="col-12">
      <div class="card" style="background: linear-gradient(135deg,#4facfe,#00f2fe); color: #fff;">
        <div class="card-body d-flex justify-content-between align-items-center">
          <div>
            <h3 class="mb-1"><i class="fas fa-history mr-2"></i>Attendance History</h3>
            <div class="text-white-75">Full history for Teachers and Students</div>
          </div>
          <div>
            <a href="{% url 'staffs:attendance-dashboard' %}" class="btn btn-light btn-sm"><i class="fas fa-user-check mr-1"></i>Staff Dashboard</a>
            <a href="{% url 'attendance:daily_dashboard' %}" class="btn btn-outline-light btn-sm"><i class="fas fa-users mr-1"></i>Student Dashboard</a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <ul class="nav nav-tabs" id="historyTabs" role="tablist">
    <li class="nav-item">
      <a class="nav-link active" id="teachers-tab" data-toggle="tab" href="#teachers" role="tab">
        <i class="fas fa-chalkboard-teacher"></i> Teachers
      </a>
    </li>
    <li class="nav-item">
      <a class="nav-link" id="students-tab" data-toggle="tab" href="#students" role="tab">
        <i class="fas fa-user-graduate"></i> Students
      </a>
    </li>
  </ul>
  <div class="tab-content" id="historyTabsContent">
    <!-- Teachers -->
    <div class="tab-pane fade show active" id="teachers" role="tabpanel">
      <div class="card mt-3 shadow-sm">
        <div class="card-header bg-white">
          <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Teacher Attendance</h5>
            <a href="{% url 'staffs:mark-attendance' %}" class="btn btn-success btn-sm"><i class="fas fa-edit mr-1"></i>Mark Attendance</a>
          </div>
        </div>
        <div class="card-body">
          <form method="get" class="form-row">
            <div class="form-group col-md-3">
              <label>Teacher</label>
              <select name="teacher" class="form-control">
                <option value="">All</option>
                {% for t in teachers %}
                <option value="{{ t.id }}" {% if filters.teacher == t.id|stringformat:'i' %}selected{% endif %}>{{ t.firstname }} {{ t.surname }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="form-group col-md-3">
              <label>Month</label>
              <select name="t_month" class="form-control">
                <option value="">All</option>
                <option value="1" {% if filters.t_month == '1' %}selected{% endif %}>1</option>
                <option value="2" {% if filters.t_month == '2' %}selected{% endif %}>2</option>
                <option value="3" {% if filters.t_month == '3' %}selected{% endif %}>3</option>
                <option value="4" {% if filters.t_month == '4' %}selected{% endif %}>4</option>
                <option value="5" {% if filters.t_month == '5' %}selected{% endif %}>5</option>
                <option value="6" {% if filters.t_month == '6' %}selected{% endif %}>6</option>
                <option value="7" {% if filters.t_month == '7' %}selected{% endif %}>7</option>
                <option value="8" {% if filters.t_month == '8' %}selected{% endif %}>8</option>
                <option value="9" {% if filters.t_month == '9' %}selected{% endif %}>9</option>
                <option value="10" {% if filters.t_month == '10' %}selected{% endif %}>10</option>
                <option value="11" {% if filters.t_month == '11' %}selected{% endif %}>11</option>
                <option value="12" {% if filters.t_month == '12' %}selected{% endif %}>12</option>
              </select>
            </div>
            <div class="form-group col-md-3">
              <label>Status</label>
              <select name="t_status" class="form-control">
                <option value="">All</option>
                <option value="present" {% if filters.t_status == 'present' %}selected{% endif %}>Present</option>
                <option value="absent" {% if filters.t_status == 'absent' %}selected{% endif %}>Absent</option>
                <option value="late" {% if filters.t_status == 'late' %}selected{% endif %}>Late</option>
                <option value="half_day" {% if filters.t_status == 'half_day' %}selected{% endif %}>Half Day</option>
                <option value="leave" {% if filters.t_status == 'leave' %}selected{% endif %}>On Leave</option>
              </select>
            </div>
            <div class="form-group col-md-3 d-flex align-items-end">
              <button class="btn btn-primary btn-block" type="submit"><i class="fas fa-filter mr-1"></i>Filter</button>
            </div>
          </form>

          <div class="table-responsive mt-3">
            <table class="table table-hover align-middle">
              <thead class="thead-light">
                <tr>
                  <th>Date</th>
                  <th>Teacher</th>
                  <th>Status</th>
                  <th>Time In</th>
                  <th>Time Out</th>
                  <th>Notes</th>
                </tr>
              </thead>
              <tbody>
                {% for r in t_page_obj %}
                <tr>
                  <td>{{ r.date }}</td>
                  <td>{{ r.teacher.firstname }} {{ r.teacher.surname }}</td>
                  <td>
                    {% if r.status == 'present' %}<span class="badge badge-success">Present</span>
                    {% elif r.status == 'absent' %}<span class="badge badge-danger">Absent</span>
                    {% elif r.status == 'late' %}<span class="badge badge-warning">Late</span>
                    {% elif r.status == 'half_day' %}<span class="badge badge-info">Half Day</span>
                    {% else %}<span class="badge badge-secondary">{{ r.get_status_display }}</span>{% endif %}
                  </td>
                  <td>{{ r.time_in|default:'--:--' }}</td>
                  <td>{{ r.time_out|default:'--:--' }}</td>
                  <td><small class="text-muted">{{ r.notes|default:'-'|truncatewords:8 }}</small></td>
                </tr>
                {% empty %}
                <tr><td colspan="6" class="text-center py-4 text-muted">No teacher records</td></tr>
                {% endfor %}
              </tbody>
            </table>
          </div>

          {% if t_page_obj.has_other_pages %}
          <nav class="mt-3">
            <ul class="pagination justify-content-center">
              {% if t_page_obj.has_previous %}
              <li class="page-item"><a class="page-link" href="?t_page={{ t_page_obj.previous_page_number }}">Previous</a></li>
              {% else %}
              <li class="page-item disabled"><span class="page-link">Previous</span></li>
              {% endif %}
              {% for i in t_page_obj.paginator.page_range %}
                {% if t_page_obj.number == i %}
                <li class="page-item active"><span class="page-link">{{ i }}</span></li>
                {% else %}
                <li class="page-item"><a class="page-link" href="?t_page={{ i }}">{{ i }}</a></li>
                {% endif %}
              {% endfor %}
              {% if t_page_obj.has_next %}
              <li class="page-item"><a class="page-link" href="?t_page={{ t_page_obj.next_page_number }}">Next</a></li>
              {% else %}
              <li class="page-item disabled"><span class="page-link">Next</span></li>
              {% endif %}
            </ul>
          </nav>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Students -->
    <div class="tab-pane fade" id="students" role="tabpanel">
      <div class="card mt-3 shadow-sm">
        <div class="card-header bg-white">
          <h5 class="mb-0">Student Attendance Registers</h5>
        </div>
        <div class="card-body">
          <form method="get" class="form-row">
            <div class="form-group col-md-3">
              <label>Class</label>
              <select name="s_class" class="form-control">
                <option value="">All</option>
                {% for c in classes %}
                <option value="{{ c.id }}" {% if filters.s_class == c.id|stringformat:'i' %}selected{% endif %}>{{ c.name }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="form-group col-md-3">
              <label>Date From</label>
              <input type="date" name="s_date_from" class="form-control" value="{{ filters.s_date_from }}">
            </div>
            <div class="form-group col-md-3">
              <label>Date To</label>
              <input type="date" name="s_date_to" class="form-control" value="{{ filters.s_date_to }}">
            </div>
            <div class="form-group col-md-2">
              <label>Status</label>
              <select name="s_locked" class="form-control">
                <option value="">Any</option>
                <option value="open" {% if filters.s_locked == 'open' %}selected{% endif %}>Open</option>
                <option value="locked" {% if filters.s_locked == 'locked' %}selected{% endif %}>Locked</option>
              </select>
            </div>
            <div class="form-group col-md-1 d-flex align-items-end">
              <button class="btn btn-primary btn-block" type="submit"><i class="fas fa-filter"></i></button>
            </div>
          </form>

          <div class="table-responsive mt-3">
            <table class="table table-hover align-middle">
              <thead class="thead-light">
                <tr>
                  <th>Date</th>
                  <th>Class</th>
                  <th>Term/Session</th>
                  <th>Attendance</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for reg in s_page_obj %}
                <tr>
                  <td>{{ reg.date }}</td>
                  <td>{{ reg.student_class }}</td>
                  <td><small class="text-muted">{{ reg.term }} â€¢ {{ reg.session }}</small></td>
                  <td>
                    <span class="text-success mr-2">{{ reg.present_count }}P</span>
                    <span class="text-danger mr-2">{{ reg.absent_count }}A</span>
                    <span class="text-warning">{{ reg.late_count }}L</span>
                  </td>
                  <td>
                    {% if reg.is_locked %}<span class="badge badge-success">Locked</span>
                    {% else %}<span class="badge badge-warning">Open</span>{% endif %}
                  </td>
                  <td>
                    <div class="btn-group btn-group-sm">
                      <a href="{% url 'attendance:take_attendance' reg.pk %}" class="btn btn-outline-primary"><i class="fas fa-edit"></i></a>
                      <a href="{% url 'attendance:register_detail' reg.pk %}" class="btn btn-outline-info"><i class="fas fa-eye"></i></a>
                    </div>
                  </td>
                </tr>
                {% empty %}
                <tr><td colspan="6" class="text-center py-4 text-muted">No registers found</td></tr>
                {% endfor %}
              </tbody>
            </table>
          </div>

          {% if s_page_obj.has_other_pages %}
          <nav class="mt-3">
            <ul class="pagination justify-content-center">
              {% if s_page_obj.has_previous %}
              <li class="page-item"><a class="page-link" href="?s_page={{ s_page_obj.previous_page_number }}">Previous</a></li>
              {% else %}
              <li class="page-item disabled"><span class="page-link">Previous</span></li>
              {% endif %}
              {% for i in s_page_obj.paginator.page_range %}
                {% if s_page_obj.number == i %}
                <li class="page-item active"><span class="page-link">{{ i }}</span></li>
                {% else %}
                <li class="page-item"><a class="page-link" href="?s_page={{ i }}">{{ i }}</a></li>
                {% endif %}
              {% endfor %}
              {% if s_page_obj.has_next %}
              <li class="page-item"><a class="page-link" href="?s_page={{ s_page_obj.next_page_number }}">Next</a></li>
              {% else %}
              <li class="page-item disabled"><span class="page-link">Next</span></li>
              {% endif %}
            </ul>
          </nav>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<style>
.nav-tabs .nav-link { font-weight: 600; }
.badge { font-size: 0.75rem; }
</style>
{% endblock %}